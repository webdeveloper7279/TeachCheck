<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeachCheck - Til o'qituvchilari uchun platforma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-button { transition: all 0.3s ease; }
        .tab-button:hover { transform: translateY(-2px); }
        .material-card, .teacher-card { transition: all 0.3s ease; }
        .material-card:hover, .teacher-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .feedback-item { animation: slideIn 0.5s ease forwards; opacity: 0; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } from { transform: translateX(-20px); } }
        .profile-preview { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chat-message { animation: messageSlide 0.3s ease; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">TeachCheck</h1>
                    <p class="text-sm text-gray-600">Til o'qituvchilari uchun sun'iy intellekt platformasi</p>
                </div>
                <div class="flex items-center gap-4">
                    <select id="language-selector" onchange="changeLanguage()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="uz">O'zbek</option>
                        <option value="ru">Русский</option>
                        <option value="en">English</option>
                    </select>
                    <button onclick="showNotifications()" class="relative p-2 text-gray-600 hover:text-indigo-600 transition">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Notifications Toast -->
    <div id="notifications-toast" class="hidden fixed top-20 right-4 bg-white rounded-lg shadow-xl p-4 w-80 z-50 notification">
        <h3 class="font-bold text-gray-800 mb-3">Bildirishnomalar</h3>
        <div class="space-y-2">
            <div class="p-3 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-800 font-medium">Yangi material sotildi!</p>
                <p class="text-xs text-gray-600">Present Simple taqdimoti</p>
            </div>
            <div class="p-3 bg-green-50 rounded-lg">
                <p class="text-sm text-gray-800 font-medium">Yangi xabar</p>
                <p class="text-xs text-gray-600">Anna Karimova sizga xabar yubordi</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="flex gap-4 mb-6 flex-wrap">
            <button onclick="showTab('homework')" id="tab-homework" class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-indigo-600 text-white">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                    <circle cx="12" cy="13" r="3"></circle>
                </svg>
                Uy vazifani tekshirish
            </button>
            <button onclick="showTab('profile')" id="tab-profile" class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-white text-gray-700 hover:bg-gray-50">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Mening profilim
            </button>
            <button onclick="showTab('my-materials')" id="tab-my-materials" class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-white text-gray-700 hover:bg-gray-50">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
                Mening materiallarim
            </button>
            <button onclick="showTab('teachers')" id="tab-teachers" class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-white text-gray-700 hover:bg-gray-50">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                O'qituvchilar
            </button>
            <button onclick="showTab('chat')" id="tab-chat" class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-white text-gray-700 hover:bg-gray-50">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Chat / Maslahat
            </button>
            <button onclick="showTab('materials')" id="tab-materials" class="tab-button flex items-center gap-2 px-6 py-3 rounded-lg font-medium bg-white text-gray-700 hover:bg-gray-50">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                Materiallar bozori
            </button>
        </div>

        <!-- Homework Checker Tab -->
        <div id="content-homework" class="tab-content bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Sun'iy intellekt bilan uy vazifalarini tekshirish</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Uy vazifani yuklash (Skan yoki rasm)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-400 transition cursor-pointer">
                        <input type="file" accept="image/*" id="homework-file" class="hidden" onchange="handleFileSelect(event)">
                        <label for="homework-file" class="cursor-pointer">
                            <svg class="mx-auto mb-3 text-gray-400" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="text-gray-600" id="file-name">Yuklash uchun bosing yoki sudrab olib keling</p>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tekshirish ko'rsatmalari</label>
                    <textarea id="checking-prompt" placeholder="Masalan: Barcha 10 ta gapda Present Simple to'g'ri ishlatilganligini tekshiring." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" rows="4"></textarea>
                </div>
                <button onclick="checkHomework()" id="check-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="check-button-text">Sun'iy intellekt bilan tekshirish</span>
                </button>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="hidden flex flex-col items-center justify-center py-8">
                    <div class="spinner mb-4"></div>
                    <p class="text-gray-600">AI tekshirmoqda...</p>
                    <p class="text-sm text-gray-500 mt-2">Bu 10-15 soniya davom etishi mumkin</p>
                </div>
                <div id="results-section" class="hidden mt-8 border-t pt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Natijalar</h3>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-3xl font-bold text-green-600" id="correct-count">0</p>
                            <p class="text-sm text-gray-600">To'g'ri</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <p class="text-3xl font-bold text-red-600" id="incorrect-count">0</p>
                            <p class="text-sm text-gray-600">Noto'g'ri</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <p class="text-3xl font-bold text-blue-600" id="accuracy">0%</p>
                            <p class="text-sm text-gray-600">Aniqlik</p>
                        </div>
                    </div>
                    <div id="feedback-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- My Profile Tab -->
        <div id="content-profile" class="tab-content hidden bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Mening profilim</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">To'liq ism sharif</label>
                        <input type="text" id="teacher-name" onkeyup="updateProfilePreview()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Ismingiz">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ish joyi</label>
                        <input type="text" id="teacher-workplace" onkeyup="updateProfilePreview()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Maktab yoki ta'lim muassasasi">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ish tajribasi (yil)</label>
                        <input type="number" id="teacher-experience" onkeyup="updateProfilePreview()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Necha yil">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">O'quvchilarning o'rtacha natijalari (%)</label>
                        <input type="number" id="student-results" onkeyup="updateProfilePreview()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="O'rtacha foiz">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                        <textarea id="teacher-bio" onkeyup="updateProfilePreview()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" rows="3" placeholder="O'zingiz haqingizda"></textarea>
                    </div>
                    <button onclick="saveProfile()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition">Profilni saqlash</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Profil ko'rinishi</h3>
                    <div id="profile-preview" class="profile-preview border border-gray-200 rounded-lg p-6 bg-gradient-to-br from-indigo-50 to-purple-50">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                <span id="preview-initials">?</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-xl font-bold text-gray-800" id="preview-name">Sizning ismingiz</h4>
                                <p class="text-sm text-gray-600" id="preview-workplace">Ish joyi</p>
                            </div>
                            <div class="flex items-center gap-1 bg-white px-3 py-2 rounded-full shadow-sm">
                                <svg class="text-yellow-400 fill-yellow-400" width="20" height="20" viewBox="0 0 24 24">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                <span class="font-bold text-gray-800" id="preview-rating">0.0</span>
                            </div>
                        </div>
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center gap-2 text-sm text-gray-700">
                                <svg class="text-indigo-500" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span id="preview-experience">0 yil tajriba</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-700">
                                <svg class="text-indigo-500" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
                                    <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
                                </svg>
                                <span id="preview-results">0% natijalar</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mb-4" id="preview-bio">Bio ma'lumoti</p>
                        <div class="bg-white rounded-lg p-4">
                            <h5 class="font-semibold text-gray-800 mb-2">Materiallar</h5>
                            <p class="text-sm text-gray-600" id="preview-materials">0 ta material</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Materials Tab -->
        <div id="content-my-materials" class="tab-content hidden bg-white rounded-xl shadow-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Mening materiallarim</h2>
                <button onclick="showUploadModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition">
                    + Yangi material yuklash
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-6 rounded-lg text-center">
                    <p class="text-3xl font-bold text-blue-600" id="my-total-materials">0</p>
                    <p class="text-sm text-gray-600">Jami materiallar</p>
                </div>
                <div class="bg-green-50 p-6 rounded-lg text-center">
                    <p class="text-3xl font-bold text-green-600" id="my-free-materials">0</p>
                    <p class="text-sm text-gray-600">Bepul</p>
                </div>
                <div class="bg-purple-50 p-6 rounded-lg text-center">
                    <p class="text-3xl font-bold text-purple-600" id="my-paid-materials">0</p>
                    <p class="text-sm text-gray-600">Pulli</p>
                </div>
            </div>
            <div id="my-materials-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center">
                    <p class="text-gray-500 mb-4">Hozircha materiallar yo'q</p>
                    <button onclick="showUploadModal()" class="text-indigo-600 font-medium hover:text-indigo-700">Material yuklang</button>
                </div>
            </div>
        </div>

        <!-- Teachers Directory Tab -->
        <div id="content-teachers" class="tab-content hidden bg-white rounded-xl shadow-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">O'qituvchilar</h2>
                <div class="flex gap-2 flex-wrap">
                    <input type="text" id="teacher-search" placeholder="Qidirish..." onkeyup="searchTeachers()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <select id="teacher-filter" onchange="filterTeachers()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="all">Barchasi</option>
                        <option value="english">Ingliz tili</option>
                        <option value="russian">Rus tili</option>
                    </select>
                    <select id="teacher-sort" onchange="sortTeachers()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="rating">Reyting bo'yicha</option>
                        <option value="experience">Tajriba bo'yicha</option>
                        <option value="materials">Materiallar bo'yicha</option>
                    </select>
                </div>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="teachers-grid"></div>
        </div>

        <!-- Chat/Advice Tab -->
        <div id="content-chat" class="tab-content hidden bg-white rounded-xl shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Chat va maslahatlar</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-1 border-r pr-4">
                    <h3 class="font-semibold text-gray-800 mb-4">Suhbatlar</h3>
                    <div class="space-y-2" id="chat-list">
                        <div onclick="openChat('Anna Karimova')" class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <p class="font-medium text-gray-800">Anna Karimova</p>
                            <p class="text-xs text-gray-500">15-maktab • 8 yil</p>
                        </div>
                        <div onclick="openChat('Ivan Petrov')" class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <p class="font-medium text-gray-800">Ivan Petrov</p>
                            <p class="text-xs text-gray-500">32-maktab • 12 yil</p>
                        </div>
                        <div onclick="openChat('Maria Sidorova')" class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <p class="font-medium text-gray-800">Maria Sidorova</p>
                            <p class="text-xs text-gray-500">7-maktab • 5 yil</p>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <div id="chat-window" class="hidden">
                        <div class="flex items-center gap-3 mb-4 pb-4 border-b">
                            <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                <span id="chat-initials">AK</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800" id="chat-name">Anna Karimova</h3>
                                <p class="text-xs text-gray-500" id="chat-info">15-maktab • 8 yil tajriba</p>
                            </div>
                        </div>
                        <div id="chat-messages" class="h-96 overflow-y-auto mb-4 space-y-3 p-4 bg-gray-50 rounded-lg">
                            <!-- Messages will appear here -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" placeholder="Xabar yozing..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition">Yuborish</button>
                        </div>
                    </div>
                    <div id="chat-placeholder" class="flex items-center justify-center h-96 text-gray-400">
                        <p>Suhbatni boshlash uchun o'qituvchini tanlang</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Marketplace Tab -->
        <div id="content-materials" class="tab-content hidden bg-white rounded-xl shadow-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Materiallar bozori</h2>
                <button onclick="showUploadModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition">Material yuklash</button>
            </div>
            <div class="mb-6 flex gap-4 flex-wrap">
                <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option>Barcha materiallar</option>
                    <option>Bepul</option>
                    <option>Pulli</option>
                </select>
                <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option>Barcha turlar</option>
                    <option>PPT</option>
                    <option>PDF</option>
                    <option>Video</option>
                    <option>Worksheet</option>
                </select>
                <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option>Barcha mavzular</option>
                    <option>Grammatika</option>
                    <option>Lug'at</option>
                    <option>O'qish</option>
                </select>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="materials-grid"></div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">To'lov</h3>
            <div id="payment-material-info" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <!-- Material info will be inserted here -->
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">To'lov usulini tanlang</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectPaymentMethod('click')" class="payment-method-btn border-2 border-gray-300 rounded-lg p-4 hover:border-indigo-600 transition flex flex-col items-center">
                            <svg class="w-12 h-12 mb-2" viewBox="0 0 24 24" fill="none">
                                <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M3 10h18" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span class="font-medium">Click</span>
                        </button>
                        <button onclick="selectPaymentMethod('payme')" class="payment-method-btn border-2 border-gray-300 rounded-lg p-4 hover:border-indigo-600 transition flex flex-col items-center">
                            <svg class="w-12 h-12 mb-2" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 6v6l4 4" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span class="font-medium">Payme</span>
                        </button>
                    </div>
                </div>

                <div id="card-details" class="hidden space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Karta raqami</label>
                        <input type="text" id="card-number" placeholder="8600 0000 0000 0000" maxlength="19" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amal qilish muddati</label>
                            <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                            <input type="text" id="card-cvv" placeholder="***" maxlength="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                    </div>
                </div>

                <div id="payment-phone" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefon raqami</label>
                    <input type="tel" placeholder="+998 90 123 45 67" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="closePaymentModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition">
                        Bekor qilish
                    </button>
                    <button onclick="processPurchase()" id="pay-button" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition disabled:bg-gray-400" disabled>
                        <span id="pay-button-text">To'lov usulini tanlang</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Material Modal -->
    <div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Material yuklash</h3>
            <div class="space-y-4">
                <input type="text" id="material-title" placeholder="Material nomi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <select id="material-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option>Material turini tanlang</option>
                    <option>PPT/Taqdimot</option>
                    <option>Worksheet</option>
                    <option>Video</option>
                    <option>PDF</option>
                    <option>Energizer</option>
                </select>
                <select id="material-topic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option>Mavzuni tanlang</option>
                    <option>Grammatika</option>
                    <option>Lug'at</option>
                    <option>O'qish</option>
                    <option>Yozish</option>
                    <option>Tinglash</option>
                    <option>Gapirish</option>
                </select>
                <textarea id="material-description" placeholder="Qisqacha tavsif" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" rows="3"></textarea>
                <select id="material-price-type" onchange="togglePrice()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option value="free">Bepul</option>
                    <option value="paid">Pulli</option>
                </select>
                <input type="number" id="material-price" placeholder="Narx (so'm)" class="hidden w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <input type="file" id="material-file" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <div class="flex gap-3">
                    <button onclick="closeUploadModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-300 transition">Bekor qilish</button>
                    <button onclick="uploadMaterial()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition">Yuklash</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentProfile = { name: '', workplace: '', experience: 0, studentResults: 0, bio: '', rating: 0 };
        let myMaterials = [];
        let currentChatUser = '';
        let filteredTeachers = [];
        let currentLanguage = 'uz';
        let selectedPaymentMethod = null;
        let currentPurchaseMaterial = null;

        // Translations
        const translations = {
            uz: {
                homework: 'Uy vazifalarini tekshirish',
                myProfile: 'Mening profilim',
                teachers: "O'qituvchilar",
                marketplace: 'Materiallar bozori'
            },
            ru: {
                homework: 'Проверка домашних заданий',
                myProfile: 'Мой профиль',
                teachers: 'Учителя',
                marketplace: 'Маркетплейс материалов'
            },
            en: {
                homework: 'Homework Checker',
                myProfile: 'My Profile',
                teachers: 'Teachers',
                marketplace: 'Materials Marketplace'
            }
        };

        // Utility Functions
        function sanitizeInput(input) {
            return input.replace(/[<>]/g, '');
        }

        function validateFile(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            return allowedTypes.includes(file.type) && file.size <= maxSize;
        }

        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('LocalStorage error:', e);
                return false;
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('LocalStorage error:', e);
                return null;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification fixed top-24 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function changeLanguage() {
            currentLanguage = document.getElementById('language-selector').value;
            // In production, this would update all UI text
            showNotification('Til o\'zgartirildi / Language changed', 'success');
        }

        function showNotifications() {
            const toast = document.getElementById('notifications-toast');
            toast.classList.toggle('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }

        const teachersData = [
            { name: 'Anna Karimova', workplace: '15-maktab', experience: 8, studentResults: 87, rating: 8.7, materials: 12, bio: 'Ingliz tili o\'qituvchisi, zamonaviy metodlar mutaxassisi', subject: 'english' },
            { name: 'Ivan Petrov', workplace: '32-maktab', experience: 12, studentResults: 92, rating: 9.2, materials: 18, bio: 'Rus tili va adabiyoti o\'qituvchisi', subject: 'russian' },
            { name: 'Maria Sidorova', workplace: '7-maktab', experience: 5, studentResults: 78, rating: 7.8, materials: 6, bio: 'Yangi boshlagan o\'qituvchi, grammatika mutaxassisi', subject: 'english' },
            { name: 'Olga Volkova', workplace: 'Lingvistik litsey', experience: 15, studentResults: 95, rating: 9.5, materials: 24, bio: 'Tajribali o\'qituvchi, IELTS tayyorlov', subject: 'english' },
            { name: 'Dmitriy Sokolov', workplace: '21-maktab', experience: 10, studentResults: 85, rating: 8.5, materials: 15, bio: 'Rus tili o\'qituvchisi', subject: 'russian' }
        ];

        // Load saved data on startup
        window.onload = function() {
            const savedProfile = loadFromLocalStorage('teacherProfile');
            const savedMaterials = loadFromLocalStorage('myMaterials');
            
            if (savedProfile) {
                currentProfile = savedProfile;
                document.getElementById('teacher-name').value = savedProfile.name || '';
                document.getElementById('teacher-workplace').value = savedProfile.workplace || '';
                document.getElementById('teacher-experience').value = savedProfile.experience || '';
                document.getElementById('student-results').value = savedProfile.studentResults || '';
                document.getElementById('teacher-bio').value = savedProfile.bio || '';
                updateProfilePreview();
            }
            
            if (savedMaterials) {
                myMaterials = savedMaterials;
            }
            
            filteredTeachers = [...teachersData];
        };

        const marketplaceMaterials = [
            { title: 'Present Simple taqdimoti', author: 'Anna Karimova', type: 'PPT', topic: 'Grammatika', price: 'Bepul', rating: 4.8, reviews: 24, workplace: '15-maktab', experience: 8 },
            { title: 'O\'tgan zamon mashqlari', author: 'Ivan Petrov', type: 'Worksheet', topic: 'Grammatika', price: '50,000', rating: 4.9, reviews: 38, workplace: '32-maktab', experience: 12 },
            { title: 'Lug\'at ishlash varaqlari', author: 'Maria Sidorova', type: 'PDF', topic: 'Lug\'at', price: '30,000', rating: 4.7, reviews: 19, workplace: '7-maktab', experience: 5 },
            { title: 'Energizer to\'plami', author: 'Olga Volkova', type: 'Video', topic: 'Umumiy', price: 'Bepul', rating: 4.9, reviews: 45, workplace: 'Lingvistik litsey', experience: 15 },
            { title: 'IELTS Speaking Practice', author: 'Olga Volkova', type: 'PPT', topic: 'Gapirish', price: '75,000', rating: 5.0, reviews: 62, workplace: 'Lingvistik litsey', experience: 15 },
            { title: 'Fonetika darslari', author: 'Anna Karimova', type: 'Video', topic: 'Talaffuz', price: '40,000', rating: 4.6, reviews: 31, workplace: '15-maktab', experience: 8 }
        ];

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700');
            });
            
            document.getElementById('content-' + tabName).classList.remove('hidden');
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.remove('bg-white', 'text-gray-700');
            activeBtn.classList.add('bg-indigo-600', 'text-white');

            if (tabName === 'teachers') loadTeachers();
            if (tabName === 'materials') loadMarketplaceMaterials();
            if (tabName === 'my-materials') loadMyMaterials();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (!validateFile(file)) {
                    showNotification('Fayl turi yoki hajmi noto\'g\'ri! (Max 5MB, JPG/PNG/PDF)', 'error');
                    event.target.value = '';
                    return;
                }
                selectedFile = file;
                document.getElementById('file-name').textContent = file.name;
                showNotification('Fayl yuklandi', 'success');
            }
        }

        async function checkHomework() {
            const prompt = document.getElementById('checking-prompt').value;
            if (!selectedFile || !prompt) {
                showNotification("Iltimos, uy vazifani yuklang va tekshirish ko'rsatmalarini kiriting", 'error');
                return;
            }

            // Show loading
            const checkButton = document.getElementById('check-button');
            const spinner = document.getElementById('loading-spinner');
            checkButton.disabled = true;
            checkButton.classList.add('opacity-50');
            spinner.classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');

            // Simulate API call (in production, replace with actual AI API)
            await new Promise(resolve => setTimeout(resolve, 2000));

            const mockResults = {
                correct: 7, incorrect: 3, total: 10,
                feedback: [
                    { status: 'correct', text: 'She works at a hospital.' },
                    { status: 'correct', text: 'They live in Moscow.' },
                    { status: 'incorrect', text: 'He are going to school.', correction: 'He goes to school.' },
                    { status: 'correct', text: 'I study English every day.' },
                    { status: 'incorrect', text: 'We plays football.', correction: 'We play football.' },
                    { status: 'correct', text: 'She speaks Russian fluently.' },
                    { status: 'correct', text: 'They work hard.' },
                    { status: 'incorrect', text: "He don't like tea.", correction: "He doesn't like tea." },
                    { status: 'correct', text: 'I teach English.' },
                    { status: 'correct', text: 'We understand the lesson.' }
                ]
            };

            // Hide loading, show results
            spinner.classList.add('hidden');
            checkButton.disabled = false;
            checkButton.classList.remove('opacity-50');

            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('correct-count').textContent = mockResults.correct;
            document.getElementById('incorrect-count').textContent = mockResults.incorrect;
            document.getElementById('accuracy').textContent = Math.round((mockResults.correct / mockResults.total) * 100) + '%';

            const feedbackList = document.getElementById('feedback-list');
            feedbackList.innerHTML = '';
            mockResults.feedback.forEach((item, index) => {
                const feedbackItem = document.createElement('div');
                feedbackItem.className = `feedback-item p-4 rounded-lg flex items-start gap-3 ${item.status === 'correct' ? 'bg-green-50' : 'bg-red-50'}`;
                feedbackItem.style.animationDelay = `${index * 0.1}s`;
                const icon = item.status === 'correct' 
                    ? '<svg class="text-green-600 flex-shrink-0 mt-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                    : '<svg class="text-red-600 flex-shrink-0 mt-1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                const correction = item.correction ? `<p class="text-sm text-gray-600 mt-1"><span class="font-medium">To'g'rilash:</span> ${item.correction}</p>` : '';
                feedbackItem.innerHTML = `${icon}<div class="flex-1"><p class="font-medium text-gray-800">${sanitizeInput(item.text)}</p>${correction}</div>`;
                feedbackList.appendChild(feedbackItem);
            });

            showNotification('Tekshirish yakunlandi!', 'success');
        }

        function updateProfilePreview() {
            const name = document.getElementById('teacher-name').value || 'Sizning ismingiz';
            const workplace = document.getElementById('teacher-workplace').value || 'Ish joyi';
            const experience = parseInt(document.getElementById('teacher-experience').value) || 0;
            const results = parseInt(document.getElementById('student-results').value) || 0;
            const bio = document.getElementById('teacher-bio').value || 'Bio ma\'lumoti';

            let rating = 5;
            rating += Math.min(experience * 0.2, 2);
            rating += Math.min(results * 0.03, 3);
            rating = Math.min(rating, 10).toFixed(1);

            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

            document.getElementById('preview-initials').textContent = initials || '?';
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-workplace').textContent = workplace;
            document.getElementById('preview-experience').textContent = `${experience} yil tajriba`;
            document.getElementById('preview-results').textContent = `${results}% natijalar`;
            document.getElementById('preview-bio').textContent = bio;
            document.getElementById('preview-rating').textContent = rating;
            document.getElementById('preview-materials').textContent = `${myMaterials.length} ta material`;

            currentProfile = { name, workplace, experience, studentResults: results, bio, rating: parseFloat(rating) };
        }

        function saveProfile() {
            if (!currentProfile.name || !currentProfile.workplace || !currentProfile.experience || !currentProfile.studentResults) {
                showNotification("Iltimos, barcha maydonlarni to'ldiring", 'error');
                return;
            }
            
            // Save to localStorage
            saveToLocalStorage('teacherProfile', currentProfile);
            
            showNotification("Profil muvaffaqiyatli saqlandi!", 'success');
            
            teachersData.unshift({
                name: currentProfile.name,
                workplace: currentProfile.workplace,
                experience: currentProfile.experience,
                studentResults: currentProfile.studentResults,
                rating: currentProfile.rating,
                materials: myMaterials.length,
                bio: currentProfile.bio,
                subject: 'english'
            });
            
            filteredTeachers = [...teachersData];
        }

        // Search and Filter Functions
        const searchTeachers = debounce(function() {
            const query = document.getElementById('teacher-search').value.toLowerCase();
            filteredTeachers = teachersData.filter(t => 
                t.name.toLowerCase().includes(query) || 
                t.workplace.toLowerCase().includes(query)
            );
            loadTeachers();
        }, 300);

        function filterTeachers() {
            const filter = document.getElementById('teacher-filter').value;
            if (filter === 'all') {
                filteredTeachers = [...teachersData];
            } else {
                filteredTeachers = teachersData.filter(t => t.subject === filter);
            }
            loadTeachers();
        }

        function sortTeachers() {
            const sort = document.getElementById('teacher-sort').value;
            filteredTeachers.sort((a, b) => {
                if (sort === 'rating') return b.rating - a.rating;
                if (sort === 'experience') return b.experience - a.experience;
                if (sort === 'materials') return b.materials - a.materials;
                return 0;
            });
            loadTeachers();
        }

        function loadTeachers() {
            const grid = document.getElementById('teachers-grid');
            grid.innerHTML = '';
            
            if (filteredTeachers.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-500">O\'qituvchilar topilmadi</p>';
                return;
            }
            
            filteredTeachers.forEach(teacher => {
                const initials = teacher.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const card = document.createElement('div');
                card.className = 'teacher-card border border-gray-200 rounded-lg p-6 bg-gradient-to-br from-white to-indigo-50';
                card.innerHTML = `
                    <div class="flex items-start gap-3 mb-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">${initials}</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-800">${sanitizeInput(teacher.name)}</h3>
                            <p class="text-sm text-gray-600">${sanitizeInput(teacher.workplace)}</p>
                        </div>
                        <div class="flex items-center gap-1 bg-white px-2 py-1 rounded-full shadow-sm">
                            <svg class="text-yellow-400 fill-yellow-400" width="16" height="16" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            <span class="text-sm font-bold">${teacher.rating}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mb-4">${sanitizeInput(teacher.bio)}</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center gap-2 text-sm text-gray-700">
                            <svg class="text-indigo-500" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            <span>${teacher.experience} yil tajriba</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-700">
                            <svg class="text-indigo-500" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                            <span>${teacher.studentResults}% o'quvchilar natijalari</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm text-gray-700">
                            <svg class="text-indigo-500" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                            <span>${teacher.materials} ta material</span>
                        </div>
                    </div>
                    <button onclick="viewTeacherProfile('${teacher.name}')" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition mb-2">Profilni ko'rish</button>
                    <button onclick="openChat('${teacher.name}')" class="w-full bg-white border-2 border-indigo-600 text-indigo-600 py-2 rounded-lg text-sm font-medium hover:bg-indigo-50 transition">Xabar yuborish</button>
                `;
                grid.appendChild(card);
            });
        }

        function viewTeacherProfile(name) {
            alert(`${name}ning to'liq profili keyingi versiyada qo'shiladi`);
        }

        function openChat(name) {
            currentChatUser = name;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            const teacher = teachersData.find(t => t.name === name);
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('chat-initials').textContent = initials;
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-info').textContent = `${teacher.workplace} • ${teacher.experience} yil tajriba`;
            document.getElementById('chat-messages').innerHTML = `
                <div class="flex gap-2 mb-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">${initials}</div>
                    <div class="bg-white p-3 rounded-lg shadow-sm max-w-xs"><p class="text-sm text-gray-800">Assalomu alaykum! Qanday yordam bera olaman?</p></div>
                </div>
            `;
            showTab('chat');
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('chat-messages');
            const myMessage = document.createElement('div');
            myMessage.className = 'chat-message flex justify-end mb-3';
            myMessage.innerHTML = `<div class="bg-indigo-600 text-white p-3 rounded-lg shadow-sm max-w-xs"><p class="text-sm">${message}</p></div>`;
            messagesDiv.appendChild(myMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = '';

            setTimeout(() => {
                const reply = document.createElement('div');
                reply.className = 'chat-message flex gap-2 mb-3';
                const initials = currentChatUser.split(' ').map(n => n[0]).join('').toUpperCase();
                reply.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">${initials}</div>
                    <div class="bg-white p-3 rounded-lg shadow-sm max-w-xs"><p class="text-sm text-gray-800">Rahmat savolingiz uchun! Men sizga yordam berishga harakat qilaman.</p></div>
                `;
                messagesDiv.appendChild(reply);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 1000);
        }

        function loadMarketplaceMaterials() {
            const grid = document.getElementById('materials-grid');
            grid.innerHTML = '';
            marketplaceMaterials.forEach(material => {
                const card = document.createElement('div');
                card.className = 'material-card border border-gray-200 rounded-lg p-6';
                const priceClass = material.price === 'Bepul' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
                const buttonText = material.price === 'Bepul' ? 'Yuklab olish' : 'Sotib olish';
                const buttonAction = material.price === 'Bepul' ? `downloadMaterial('${material.title}')` : `openPaymentModal('${material.title}', '${material.price}', '${material.author}')`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${material.title}</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${priceClass}">${material.price === 'Bepul' ? 'Bepul' : material.price + ' so\'m'}</span>
                    </div>
                    <div class="mb-3">
                        <p class="text-sm text-gray-600 mb-1">muallif: ${material.author}</p>
                        <p class="text-xs text-gray-500">${material.workplace} • ${material.experience} yil tajriba</p>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded">${material.type}</span>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">${material.topic}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1">
                            <svg class="text-yellow-400 fill-yellow-400" width="16" height="16" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            <span class="text-sm font-medium">${material.rating}</span>
                            <span class="text-xs text-gray-500">(${material.reviews})</span>
                        </div>
                        <button onclick="${buttonAction}" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">${buttonText}</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function openPaymentModal(title, price, author) {
            currentPurchaseMaterial = { title, price, author };
            const modal = document.getElementById('payment-modal');
            const infoDiv = document.getElementById('payment-material-info');
            
            infoDiv.innerHTML = `
                <h4 class="font-bold text-gray-800 mb-2">${title}</h4>
                <p class="text-sm text-gray-600 mb-2">Muallif: ${author}</p>
                <p class="text-2xl font-bold text-indigo-600">${price} so'm</p>
            `;
            
            modal.classList.remove('hidden');
            selectedPaymentMethod = null;
            document.getElementById('card-details').classList.add('hidden');
            document.getElementById('payment-phone').classList.add('hidden');
            document.getElementById('pay-button').disabled = true;
            document.getElementById('pay-button-text').textContent = 'To\'lov usulini tanlang';
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            selectedPaymentMethod = null;
            currentPurchaseMaterial = null;
            // Clear inputs
            document.getElementById('card-number').value = '';
            document.getElementById('card-expiry').value = '';
            document.getElementById('card-cvv').value = '';
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update button states
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'bg-indigo-50');
                btn.classList.add('border-gray-300');
            });
            event.target.closest('.payment-method-btn').classList.remove('border-gray-300');
            event.target.closest('.payment-method-btn').classList.add('border-indigo-600', 'bg-indigo-50');
            
            // Show relevant input fields
            if (method === 'click') {
                document.getElementById('card-details').classList.remove('hidden');
                document.getElementById('payment-phone').classList.add('hidden');
            } else if (method === 'payme') {
                document.getElementById('card-details').classList.add('hidden');
                document.getElementById('payment-phone').classList.remove('hidden');
            }
            
            // Enable pay button
            document.getElementById('pay-button').disabled = false;
            document.getElementById('pay-button-text').textContent = `${currentPurchaseMaterial.price} so'm to'lash`;
        }

        async function processPurchase() {
            if (!selectedPaymentMethod) {
                showNotification('To\'lov usulini tanlang', 'error');
                return;
            }

            // Validate inputs
            if (selectedPaymentMethod === 'click') {
                const cardNumber = document.getElementById('card-number').value;
                const expiry = document.getElementById('card-expiry').value;
                const cvv = document.getElementById('card-cvv').value;
                
                if (!cardNumber || !expiry || !cvv) {
                    showNotification('Barcha maydonlarni to\'ldiring', 'error');
                    return;
                }
                
                if (cardNumber.replace(/\s/g, '').length < 16) {
                    showNotification('Karta raqami noto\'g\'ri', 'error');
                    return;
                }
            }

            // Show loading
            const payButton = document.getElementById('pay-button');
            const originalText = payButton.innerHTML;
            payButton.disabled = true;
            payButton.innerHTML = '<div class="spinner mx-auto"></div>';

            // Simulate payment processing (in production, call actual payment API)
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Success
            payButton.innerHTML = originalText;
            closePaymentModal();
            showNotification(`Material muvaffaqiyatli sotib olindi! ${currentPurchaseMaterial.title}`, 'success');
            
            // In production, this would trigger actual download
            setTimeout(() => {
                showNotification('Material yuklab olish boshlandi', 'success');
            }, 1000);
        }

        function downloadMaterial(title) {
            showNotification(`${title} yuklab olish boshlandi`, 'success');
            // In production, this would trigger actual download
        }

        // Format card number input
        document.addEventListener('DOMContentLoaded', function() {
            const cardNumberInput = document.getElementById('card-number');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });
            }

            const expiryInput = document.getElementById('card-expiry');
            if (expiryInput) {
                expiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                    }
                    e.target.value = value;
                });
            }
        });

        function loadMyMaterials() {
            document.getElementById('my-total-materials').textContent = myMaterials.length;
            document.getElementById('my-free-materials').textContent = myMaterials.filter(m => m.price === 'Bepul').length;
            document.getElementById('my-paid-materials').textContent = myMaterials.filter(m => m.price !== 'Bepul').length;

            const grid = document.getElementById('my-materials-grid');
            if (myMaterials.length === 0) {
                grid.innerHTML = '<div class="col-span-full border-2 border-dashed border-gray-300 rounded-lg p-12 text-center"><p class="text-gray-500 mb-4">Hozircha materiallar yo\'q</p><button onclick="showUploadModal()" class="text-indigo-600 font-medium hover:text-indigo-700">Material yuklang</button></div>';
            } else {
                grid.innerHTML = '';
                myMaterials.forEach((material, index) => {
                    const card = document.createElement('div');
                    card.className = 'material-card border border-gray-200 rounded-lg p-6';
                    const priceClass = material.price === 'Bepul' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-lg text-gray-800">${material.title}</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${priceClass}">${material.price === 'Bepul' ? 'Bepul' : material.price + ' so\'m'}</span>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded">${material.type}</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded">${material.topic}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">${material.description}</p>
                        <div class="flex gap-2">
                            <button class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">Tahrirlash</button>
                            <button onclick="deleteMaterial(${index})" class="flex-1 bg-red-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">O'chirish</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        function deleteMaterial(index) {
            if (confirm('Rostdan ham o\'chirmoqchimisiz?')) {
                myMaterials.splice(index, 1);
                loadMyMaterials();
                updateProfilePreview();
            }
        }

        function showUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
        }

        function togglePrice() {
            const priceType = document.getElementById('material-price-type').value;
            const priceInput = document.getElementById('material-price');
            if (priceType === 'paid') {
                priceInput.classList.remove('hidden');
            } else {
                priceInput.classList.add('hidden');
            }
        }

        function uploadMaterial() {
            const title = sanitizeInput(document.getElementById('material-title').value);
            const type = document.getElementById('material-type').value;
            const topic = document.getElementById('material-topic').value;
            const description = sanitizeInput(document.getElementById('material-description').value);
            const priceType = document.getElementById('material-price-type').value;
            const price = priceType === 'free' ? 'Bepul' : document.getElementById('material-price').value;
            const file = document.getElementById('material-file').files[0];

            if (!title || type === 'Material turini tanlang' || topic === 'Mavzuni tanlang' || !file) {
                showNotification('Iltimos, barcha maydonlarni to\'ldiring', 'error');
                return;
            }

            if (!validateFile(file)) {
                showNotification('Fayl turi yoki hajmi noto\'g\'ri!', 'error');
                return;
            }

            myMaterials.push({ title, type, topic, description, price, file: file.name });
            saveToLocalStorage('myMaterials', myMaterials);
            
            showNotification('Material muvaffaqiyatli yuklandi!', 'success');
            closeUploadModal();
            loadMyMaterials();
            updateProfilePreview();
            
            // Clear form
            document.getElementById('material-title').value = '';
            document.getElementById('material-type').selectedIndex = 0;
            document.getElementById('material-topic').selectedIndex = 0;
            document.getElementById('material-description').value = '';
            document.getElementById('material-price').value = '';
            document.getElementById('material-file').value = '';
        }

        showTab('homework');
    </script>
</body>
</html>